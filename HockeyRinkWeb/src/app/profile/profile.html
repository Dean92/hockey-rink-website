<div class="container py-5">
  <app-toast-container></app-toast-container>

  @if (isAdmin() && userId()) {
  <div class="mb-3">
    <button class="btn btn-outline-secondary" (click)="backToUsers()">
      <i class="bi bi-arrow-left me-2"></i>Back to User Management
    </button>
  </div>
  } @if (isLoading()) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading profile...</p>
  </div>
  } @if (errorMessage()) {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ errorMessage() }}
    <button
      type="button"
      class="btn-close"
      (click)="errorMessage.set(null)"
    ></button>
  </div>
  } @if (profile() && !isLoading()) {

  <!-- Main Profile Card -->
  <div class="profile-card mb-5">
    <!-- Header Background -->
    <div class="profile-header-bg">
      <div class="profile-avatar-container">
        <div class="profile-avatar">
          <i class="bi bi-person-fill"></i>
        </div>
      </div>

      <!-- Edit Button (Top Right) -->
      <div class="profile-actions">
        @if (!isEditing()) {
        <button
          class="btn btn-light shadow-sm fw-bold"
          (click)="toggleEdit()"
          [disabled]="isSaving()"
        >
          <i class="bi bi-pencil me-2"></i>Edit Profile
        </button>
        }
      </div>
    </div>

    <div class="profile-body">
      <!-- User Name Header -->
      <div class="mb-5">
        <h2 class="fw-bold mb-1">
          {{ profile()!.firstName }} {{ profile()!.lastName }}
        </h2>
        <p class="text-muted mb-0">
          <i class="bi bi-envelope me-2"></i>
          @if (isAdmin() && userId()) {
          <a href="mailto:{{ profile()!.email }}" class="text-decoration-none">
            {{ profile()!.email }}
          </a>
          } @else {
          {{ profile()!.email }}
          }
        </p>
      </div>

      <!-- View Mode -->
      @if (!isEditing()) {
      <div class="row g-5">
        <!-- Personal Information -->
        <div class="col-lg-6">
          <h5 class="section-title">
            <i class="bi bi-person-badge me-2 text-primary"></i>Personal
            Information
          </h5>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="info-group">
                <label class="info-label">Position</label>
                <div class="info-value">
                  <i class="bi bi-person-standing"></i>
                  {{ profile()!.position || "Not specified" }}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-group">
                <label class="info-label">Date of Birth</label>
                <div class="info-value">
                  <i class="bi bi-calendar3"></i>
                  {{
                    profile()!.dateOfBirth
                      ? (profile()!.dateOfBirth | date : "mediumDate")
                      : "Not provided"
                  }}
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="info-group">
                <label class="info-label">Current League</label>
                <div class="info-value">
                  <i class="bi bi-trophy"></i>
                  {{ getLeagueName(profile()!.leagueId) }}
                </div>
              </div>
            </div>
            @if (isAdmin() && userId()) {
            <div class="col-md-6">
              <div class="info-group">
                <label class="info-label">Player Rating</label>
                <div class="info-value">
                  <i class="bi bi-star-fill text-warning"></i>
                  {{ profile()!.rating || "Not rated" }}
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="info-group">
                <label class="info-label">Player Notes (Admin Only)</label>
                <div class="info-value">
                  <i class="bi bi-sticky"></i>
                  {{ profile()!.playerNotes || "No notes" }}
                </div>
              </div>
            </div>
            }
          </div>
        </div>

        <!-- Contact Information -->
        <div class="col-lg-6">
          <h5 class="section-title">
            <i class="bi bi-geo-alt me-2 text-primary"></i>Contact Details
          </h5>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="info-group">
                <label class="info-label">Phone</label>
                <div class="info-value">
                  <i class="bi bi-telephone"></i>
                  {{ formatPhone(profile()!.phone || "") || "Not provided" }}
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="info-group">
                <label class="info-label">Address</label>
                <div class="info-value">
                  <i class="bi bi-house-door"></i>
                  @if (profile()!.address) {
                  <span>
                    {{ profile()!.address }}
                    @if (profile()!.city || profile()!.state ||
                    profile()!.zipCode) {
                    <br class="d-md-none" />
                    <span class="ms-md-1">
                      <span>{{ profile()!.city }}</span
                      >{{ profile()!.city && profile()!.state ? "," : ""
                      }}<span>
                        {{ profile()!.state }} {{ profile()!.zipCode }}</span
                      >
                    </span>
                    }
                  </span>
                  } @else { Not provided }
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Contact & Hockey Registration -->
        <div class="row g-5 mt-2">
          <!-- Emergency Contact -->
          <div class="col-lg-6">
            <h5 class="section-title">
              <i class="bi bi-telephone-fill me-2 text-primary"></i>Emergency
              Contact
            </h5>

            <div class="row g-3">
              <div class="col-12">
                <div class="info-group">
                  <label class="info-label">Emergency Contact Name</label>
                  <div class="info-value">
                    <i class="bi bi-person"></i>
                    {{ profile()!.emergencyContactName || "Not provided" }}
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="info-group">
                  <label class="info-label">Emergency Contact Phone</label>
                  <div class="info-value">
                    <i class="bi bi-telephone"></i>
                    {{
                      formatPhone(profile()!.emergencyContactPhone || "") ||
                        "Not provided"
                    }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Hockey Registration -->
          <div class="col-lg-6">
            <h5 class="section-title">
              <i class="bi bi-card-text me-2 text-primary"></i>Hockey
              Registration
            </h5>

            <div class="row g-3">
              <div class="col-12">
                <div class="info-group">
                  <label class="info-label">Registration Type</label>
                  <div class="info-value">
                    <i class="bi bi-shield-check"></i>
                    {{ profile()!.hockeyRegistrationType || "Not provided" }}
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="info-group">
                  <label class="info-label">Registration Number</label>
                  <div class="info-value">
                    <i class="bi bi-hash"></i>
                    @if (profile()!.hockeyRegistrationType &&
                    profile()!.hockeyRegistrationNumber) {
                    {{ profile()!.hockeyRegistrationType }} #:
                    {{ profile()!.hockeyRegistrationNumber }}
                    } @else { Not provided }
                  </div>
                </div>
              </div>
              <div class="col-12">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  Registration numbers must be renewed annually
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- Edit Mode -->
      @if (isEditing()) {
      <form [formGroup]="profileForm" (ngSubmit)="onSaveProfile()">
        @if (!isAdmin() || !userId()) {
        <div class="alert alert-info mb-4 border-0 bg-primary bg-opacity-10">
          <i class="bi bi-info-circle-fill me-2 text-primary"></i>
          <span class="text-muted"
            >Name and email cannot be changed. Contact administrator if
            needed.</span
          >
        </div>
        }

        <div class="row g-4">
          <!-- Personal Info Edit -->
          <div class="col-lg-6">
            <h5 class="section-title">Personal Information</h5>
            <div class="row g-3">
              @if (isAdmin() && userId()) {
              <div class="col-md-6">
                <label class="form-label"
                  >First Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="firstName"
                  placeholder="Enter first name"
                  [class.is-invalid]="hasError('firstName', 'required')"
                />
                @if (hasError('firstName', 'required')) {
                <div class="invalid-feedback">First name is required</div>
                }
              </div>
              <div class="col-md-6">
                <label class="form-label"
                  >Last Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="lastName"
                  placeholder="Enter last name"
                  [class.is-invalid]="hasError('lastName', 'required')"
                />
                @if (hasError('lastName', 'required')) {
                <div class="invalid-feedback">Last name is required</div>
                }
              </div>
              <div class="col-12">
                <label class="form-label"
                  >Email <span class="text-danger">*</span></label
                >
                <input
                  type="email"
                  class="form-control"
                  formControlName="email"
                  placeholder="Enter email address"
                  [class.is-invalid]="
                    hasError('email', 'required') || hasError('email', 'email')
                  "
                />
                @if (hasError('email', 'required')) {
                <div class="invalid-feedback">Email is required</div>
                } @if (hasError('email', 'email')) {
                <div class="invalid-feedback">Please enter a valid email</div>
                }
              </div>
              }
              <div class="col-12">
                <label class="form-label"
                  >Position <span class="text-danger">*</span></label
                >
                <select
                  class="form-select"
                  formControlName="position"
                  [class.is-invalid]="hasError('position', 'required')"
                >
                  <option value="">Select Position</option>
                  <option value="Forward">Forward</option>
                  <option value="Defense">Defense</option>
                  <option value="Forward/Defense">Forward/Defense</option>
                  <option value="Goalie">Goalie</option>
                </select>
                @if (hasError('position', 'required')) {
                <div class="invalid-feedback">Position is required</div>
                }
              </div>
              <div class="col-12">
                <label class="form-label"
                  >Date of Birth <span class="text-danger">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  formControlName="dateOfBirth"
                  placeholder="Select your date of birth"
                  [class.is-invalid]="hasError('dateOfBirth', 'required')"
                />
                @if (hasError('dateOfBirth', 'required')) {
                <div class="invalid-feedback">Date of birth is required</div>
                }
              </div>

              <div class="col-12">
                <label class="form-label">Current League</label>
                @if (isAdmin() && userId()) {
                <select class="form-select" formControlName="leagueId">
                  <option [value]="null">No League Assigned</option>
                  @for (league of leagues(); track league.id) {
                  <option [value]="league.id">{{ league.name }}</option>
                  }
                </select>
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>Assign player to a
                  league
                </div>
                } @else {
                <div
                  class="form-control bg-light text-muted"
                  style="cursor: not-allowed"
                >
                  <i class="bi bi-trophy me-2"></i
                  >{{ getLeagueName(profile()!.leagueId) }}
                </div>
                <div class="form-text">
                  <i class="bi bi-lock me-1"></i>League assignment is managed by
                  administrators
                </div>
                }
              </div>

              <!-- Admin-only fields -->
              @if (isAdmin() && userId()) {
              <div class="col-12">
                <label class="form-label">Player Rating (Admin Only)</label>
                <input
                  type="number"
                  class="form-control"
                  formControlName="rating"
                  min="1"
                  max="5"
                  step="0.5"
                  placeholder="1-5"
                  [class.is-invalid]="
                    hasError('rating', 'min') || hasError('rating', 'max')
                  "
                />
                @if (hasError('rating', 'min') || hasError('rating', 'max')) {
                <div class="invalid-feedback">
                  Rating must be between 1 and 5
                </div>
                }
              </div>
              <div class="col-12">
                <label class="form-label">Player Notes (Admin Only)</label>
                <textarea
                  class="form-control"
                  formControlName="playerNotes"
                  rows="3"
                  placeholder="Admin notes about this player..."
                ></textarea>
              </div>
              }
            </div>
          </div>

          <!-- Contact Info Edit -->
          <div class="col-lg-6">
            <h5 class="section-title">Contact Details</h5>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label"
                  >Phone <span class="text-danger">*</span></label
                >
                <input
                  type="tel"
                  class="form-control"
                  formControlName="phone"
                  (input)="onPhoneInput($event)"
                  [class.is-invalid]="
                    hasError('phone', 'required') ||
                    hasError('phone', 'pattern')
                  "
                  placeholder="Enter phone number"
                  maxlength="14"
                />
                @if (hasError('phone', 'required')) {
                <div class="invalid-feedback">Phone number is required</div>
                } @if (hasError('phone', 'pattern')) {
                <div class="invalid-feedback">Invalid phone format</div>
                }
              </div>
              <div class="col-12">
                <label class="form-label"
                  >Address <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="address"
                  placeholder="Enter street address"
                  [class.is-invalid]="hasError('address', 'required')"
                />
                @if (hasError('address', 'required')) {
                <div class="invalid-feedback">Address is required</div>
                }
              </div>
              <div class="col-md-5">
                <label class="form-label"
                  >City <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="city"
                  placeholder="Enter city name"
                  [class.is-invalid]="hasError('city', 'required')"
                />
                @if (hasError('city', 'required')) {
                <div class="invalid-feedback">City is required</div>
                }
              </div>
              <div class="col-md-3">
                <label class="form-label"
                  >State <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="state"
                  placeholder="Enter state"
                  maxlength="2"
                  [class.is-invalid]="hasError('state', 'required')"
                />
                @if (hasError('state', 'required')) {
                <div class="invalid-feedback">State is required</div>
                }
              </div>
              <div class="col-md-4">
                <label class="form-label"
                  >Zip Code <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="zipCode"
                  placeholder="Enter zip code"
                  [class.is-invalid]="hasError('zipCode', 'required')"
                />
                @if (hasError('zipCode', 'required')) {
                <div class="invalid-feedback">Zip code is required</div>
                }
              </div>
            </div>
          </div>

          <!-- Emergency Contact Edit -->
          <div class="col-lg-6">
            <h5 class="section-title">Emergency Contact</h5>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label"> Emergency Contact Name </label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="emergencyContactName"
                  placeholder="Enter emergency contact name"
                />
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>Filled during session
                  registration
                </div>
              </div>
              <div class="col-12">
                <label class="form-label"> Emergency Contact Phone </label>
                <input
                  type="tel"
                  class="form-control"
                  formControlName="emergencyContactPhone"
                  (input)="onPhoneInput($event)"
                  placeholder="Enter phone number"
                  maxlength="14"
                />
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>Who should we contact in
                  case of emergency?
                </div>
              </div>
            </div>
          </div>

          <!-- Hockey Registration Edit -->
          <div class="col-lg-6">
            <h5 class="section-title">Hockey Registration</h5>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Registration Type</label>
                <select
                  class="form-select"
                  formControlName="hockeyRegistrationType"
                >
                  <option value="">None</option>
                  <option value="USA Hockey">USA Hockey</option>
                  <option value="AAU Hockey">AAU Hockey</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Registration Number</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="hockeyRegistrationNumber"
                  placeholder="Enter registration number"
                  [disabled]="!profileForm.get('hockeyRegistrationType')?.value"
                />
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>Your USA Hockey or AAU
                  Hockey registration number (updated annually)
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="col-12 mt-4 pt-3 border-top">
            <div class="d-flex gap-2 justify-content-end">
              <button
                type="button"
                class="btn btn-light"
                (click)="toggleEdit()"
                [disabled]="isSaving()"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="btn btn-primary px-4"
                [disabled]="profileForm.invalid || isSaving()"
              >
                @if (isSaving()) {
                <span
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                ></span>
                Saving... } @else { Save Changes }
              </button>
            </div>
          </div>
        </div>
      </form>
      }
    </div>
  </div>

  <!-- Security Section -->
  <div class="password-card card bg-white p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h5 class="fw-bold mb-1">
          <i class="bi bi-shield-lock me-2 text-primary"></i>Security Settings
        </h5>
        <p class="text-muted small mb-0">
          Manage your password and account security
        </p>
      </div>
      @if (!showChangePassword()) {
      <button class="btn btn-outline-primary" (click)="toggleChangePassword()">
        Change Password
      </button>
      }
    </div>

    @if (showChangePassword()) {
    <div class="bg-light p-4 rounded-3">
      <form [formGroup]="changePasswordForm" (ngSubmit)="onChangePassword()">
        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Current Password</label>
            <input
              type="password"
              class="form-control"
              formControlName="currentPassword"
              [class.is-invalid]="
                hasPasswordError('currentPassword', 'required')
              "
              placeholder="Enter current password"
            />
            @if (hasPasswordError('currentPassword', 'required')) {
            <div class="invalid-feedback">Current password is required</div>
            }
          </div>

          <div class="col-md-6">
            <label class="form-label">New Password</label>
            <input
              type="password"
              class="form-control"
              formControlName="newPassword"
              [class.is-invalid]="
                hasPasswordError('newPassword', 'required') ||
                hasPasswordError('newPassword', 'minlength')
              "
              placeholder="Enter new password"
            />
            @if (hasPasswordError('newPassword', 'required')) {
            <div class="invalid-feedback">New password is required</div>
            } @if (hasPasswordError('newPassword', 'minlength')) {
            <div class="invalid-feedback">
              Password must be at least 6 characters
            </div>
            }
          </div>

          <div class="col-md-6">
            <label class="form-label">Confirm New Password</label>
            <input
              type="password"
              class="form-control"
              formControlName="confirmPassword"
              [class.is-invalid]="
                hasPasswordError('confirmPassword', 'required') ||
                passwordMismatch
              "
              placeholder="Confirm new password"
            />
            @if (hasPasswordError('confirmPassword', 'required')) {
            <div class="invalid-feedback">Please confirm your password</div>
            } @if (passwordMismatch) {
            <div class="invalid-feedback">Passwords do not match</div>
            }
          </div>

          <div class="col-12 mt-4">
            <div class="d-flex gap-2">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="changePasswordForm.invalid || isChangingPassword()"
              >
                @if (isChangingPassword()) {
                <span
                  class="spinner-border spinner-border-sm me-2"
                  role="status"
                ></span>
                Updating... } @else { Update Password }
              </button>
              <button
                type="button"
                class="btn btn-light"
                (click)="toggleChangePassword()"
                [disabled]="isChangingPassword()"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
    }
  </div>
  }
</div>
