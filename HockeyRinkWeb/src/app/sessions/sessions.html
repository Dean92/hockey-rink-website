<!-- Hero Section -->
<div class="sessions-hero text-white text-center">
  <div class="container">
    <h1 class="display-4 fw-bold mb-3">Find Your Session</h1>
    <p class="lead opacity-75 mb-0">
      Browse upcoming hockey sessions, leagues, and events.
    </p>
  </div>
</div>

<div class="container pb-5">
  <!-- Error Alert -->
  @if (errorMessage()) {
  <div
    class="alert alert-danger shadow-sm rounded-3 border-0 mb-4 d-flex align-items-center"
  >
    <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
    <div>{{ errorMessage() }}</div>
  </div>
  }

  <!-- Filter Section -->
  <div class="card filter-card mb-5">
    <div class="card-body p-4">
      <h5 class="card-title mb-4 fw-bold text-primary">
        <i class="bi bi-funnel-fill me-2"></i>Filter Sessions
      </h5>
      <form [formGroup]="filterForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="leagueFilter" class="form-label">League</label>
            <select
              id="leagueFilter"
              formControlName="league"
              class="form-select"
            >
              <option value="">All Leagues</option>
              @for (league of leagues(); track league.id) {
              <option [value]="league.id">
                {{ league.name }}
              </option>
              }
            </select>
          </div>
          <div class="col-md-6">
            <label for="dateFilter" class="form-label">Date</label>
            <input
              id="dateFilter"
              type="date"
              formControlName="date"
              class="form-control"
            />
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="text-center py-5">
    <div
      class="spinner-border text-primary"
      role="status"
      style="width: 3rem; height: 3rem"
    >
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading sessions...</p>
  </div>
  } @else { @if (sessions().length) {
  <div class="row g-4">
    @for (session of sessions(); track session.id) {
    <div class="col-lg-4 col-md-6">
      <div
        class="card session-card h-100"
        [class.preferred-league]="isUserPreferredLeague(session)"
      >
        <div class="session-card-header">
          <div class="session-league-badge">
            {{ session.league?.name || "Open Session" }}
            @if (isUserPreferredLeague(session)) {
            <i class="bi bi-star-fill ms-1" title="Your League"></i>
            }
          </div>
          <h5 class="session-card-title">{{ session.name }}</h5>
        </div>

        <div class="session-card-body">
          <!-- Dates -->
          <div class="info-item">
            <div class="info-icon"><i class="bi bi-calendar-event"></i></div>
            <div>
              <strong>Start:</strong>
              {{ session.startDate | date : "mediumDate" }}<br />
              <small class="text-muted">{{
                session.startDate | date : "shortTime"
              }}</small>
            </div>
          </div>
          <div class="info-item">
            <div class="info-icon"><i class="bi bi-calendar-check"></i></div>
            <div>
              <strong>End:</strong> {{ session.endDate | date : "mediumDate"
              }}<br />
              <small class="text-muted">{{
                session.endDate | date : "shortTime"
              }}</small>
            </div>
          </div>

          <!-- Registration Dates -->
          @if (session.registrationOpenDate) {
          <div class="info-item">
            <div class="info-icon"><i class="bi bi-door-open"></i></div>
            <div>
              <span class="d-block text-muted small">Registration Opens</span>
              {{ session.registrationOpenDate | date : "mediumDate" }}
            </div>
          </div>
          }

          <!-- Capacity -->
          @if (session.maxPlayers) {
          <div class="info-item mt-3">
            <div class="info-icon"><i class="bi bi-people"></i></div>
            <div class="w-100">
              <div class="d-flex justify-content-between mb-1">
                <span>Capacity</span>
                <span class="fw-bold"
                  >{{ session.registrationCount || 0 }}/{{
                    session.maxPlayers
                  }}</span
                >
              </div>
              <div class="progress" style="height: 6px">
                <div
                  class="progress-bar"
                  role="progressbar"
                  [style.width.%]="
                    ((session.registrationCount || 0) / session.maxPlayers) *
                    100
                  "
                  [class.bg-success]="
                    (session.registrationCount || 0) / session.maxPlayers < 0.8
                  "
                  [class.bg-warning]="
                    (session.registrationCount || 0) / session.maxPlayers >=
                      0.8 &&
                    (session.registrationCount || 0) / session.maxPlayers < 1
                  "
                  [class.bg-danger]="
                    (session.registrationCount || 0) / session.maxPlayers >= 1
                  "
                ></div>
              </div>
            </div>
          </div>
          }

          <!-- Status Badge (Active/Inactive) -->
          <div class="info-item mt-3">
            <div class="info-icon"><i class="bi bi-info-circle"></i></div>
            <div>
              <strong>Status: </strong>
              <span
                [class]="
                  session.isActive ? 'badge bg-success' : 'badge bg-secondary'
                "
              >
                {{ session.isActive ? "Active" : "Inactive" }}
              </span>
            </div>
          </div>
        </div>

        <div class="session-card-footer d-block">
          @if (isRegistrationOpen(session)) {
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="price-display">
              @if (isEarlyBirdActive(session)) {
              <span class="price-label text-success">Early Bird</span>
              <span class="price-value text-success"
                >${{ session.earlyBirdPrice }}</span
              >
              <small
                class="text-muted"
                style="font-size: 0.7rem; display: block"
                >Ends
                {{
                  session.earlyBirdEndDate | date : "MMM d, y 'at' h:mm a"
                }}</small
              >
              @if (session.regularPrice) {
              <small
                class="text-muted fw-bold"
                style="font-size: 0.85rem; display: block; margin-top: 0.25rem"
                >Regular Price: ${{ session.regularPrice }}</small
              >
              } } @else if (session.regularPrice) {
              <span class="price-label">Price</span>
              <span class="price-value">${{ session.regularPrice }}</span>
              } @else {
              <span class="price-label">Fee</span>
              <span class="price-value">${{ session.fee }}</span>
              }
            </div>

            @if (session.spotsLeft !== undefined && session.spotsLeft > 0) {
            <span
              [class]="
                session.spotsLeft <= 5
                  ? 'badge bg-warning text-dark spots-badge'
                  : 'badge bg-success spots-badge'
              "
            >
              @if (session.spotsLeft <= 5) { {{ session.spotsLeft }} Left! }
              @else { Open }
            </span>
            }
          </div>
          }

          <!-- Action Buttons -->
          <div class="d-grid">
            @if (session.isActive && !session.isFull) {
            <a
              [routerLink]="['/session-registration']"
              [queryParams]="{ sessionId: session.id }"
              class="btn btn-primary fw-bold"
            >
              Register Now
            </a>
            } @else if (session.isFull) {
            <button class="btn btn-secondary" disabled>Session Full</button>
            } @else {
            <button class="btn btn-outline-secondary" disabled>
              Registration Closed
            </button>
            }
          </div>
        </div>
      </div>
    </div>
    }
  </div>
  } @else {
  <div class="text-center py-5 text-muted">
    <i class="bi bi-calendar-x display-1 mb-3 d-block opacity-25"></i>
    <h4>No sessions found</h4>
    <p>Try adjusting your filters to see more results.</p>
  </div>
  } }
</div>
