<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Manage Leagues</h2>
    <button class="btn btn-outline-secondary" routerLink="/admin">
      <i class="bi bi-arrow-left me-2"></i> Back to Admin Dashboard
    </button>
  </div>

  @if (errorMessage()) {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ errorMessage() }}
    <button
      type="button"
      class="btn-close"
      aria-label="Close error message"
      (click)="errorMessage.set(null)"
    ></button>
  </div>
  } @if (successMessage()) {
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    {{ successMessage() }}
    <button
      type="button"
      class="btn-close"
      aria-label="Close success message"
      (click)="successMessage.set(null)"
    ></button>
  </div>
  } @if (isLoading()) {
  <div class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  } @else {
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Name</th>
          <th>Start Date</th>
          <th>Early Bird Price</th>
          <th>Registration Opens</th>
          <th>Registration Closes</th>
          <th>Teams</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (league of leagues(); track league.id) {
        <tr>
          <td>{{ league.name }}</td>
          <td>{{ formatDate(league.startDate) }}</td>
          <td>{{ formatCurrency(league.earlyBirdPrice) }}</td>
          <td>{{ formatDateTime(league.registrationOpenDate) }}</td>
          <td>{{ formatDateTime(league.registrationCloseDate) }}</td>
          <td>{{ league.teamCount || 0 }}</td>
          <td>
            <button
              class="btn btn-sm btn-outline-primary"
              (click)="openEditModal(league)"
              title="Edit"
            >
              <i class="bi bi-pencil"></i> Edit
            </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="7" class="text-center">No leagues found</td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }
</div>

<!-- Modal -->
@if (showModal()) {
<div class="modal fade show d-block modal-backdrop-custom" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit League Settings</h5>
        <button
          type="button"
          class="btn-close"
          aria-label="Close modal"
          (click)="closeModal()"
        ></button>
      </div>
      <form [formGroup]="leagueForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          @if (errorMessage()) {
          <div class="alert alert-danger">{{ errorMessage() }}</div>
          }

          <div class="mb-3">
            <label for="name" class="form-label">League Name *</label>
            <input
              type="text"
              class="form-control"
              id="name"
              formControlName="name"
              [class.is-invalid]="
                leagueForm.get('name')?.invalid &&
                leagueForm.get('name')?.touched
              "
            />
            @if (leagueForm.get('name')?.invalid &&
            leagueForm.get('name')?.touched) {
            <div class="invalid-feedback">
              @if (leagueForm.get('name')?.errors?.['required']) { League name
              is required } @if (leagueForm.get('name')?.errors?.['maxlength'])
              { Maximum 100 characters allowed }
            </div>
            }
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea
              class="form-control"
              id="description"
              formControlName="description"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="startDate" class="form-label">Start Date</label>
            <input
              type="date"
              class="form-control"
              id="startDate"
              formControlName="startDate"
            />
            <small class="form-text text-muted"
              >The expected start date for this league season</small
            >
          </div>

          <div class="mb-3">
            <label for="earlyBirdPrice" class="form-label"
              >Early Bird Price ($)</label
            >
            <input
              type="number"
              class="form-control"
              id="earlyBirdPrice"
              formControlName="earlyBirdPrice"
              min="0"
              max="1000"
              step="0.01"
            />
            <small class="form-text text-muted"
              >Special pricing for early registrations</small
            >
          </div>

          <div class="mb-3">
            <label for="earlyBirdEndDate" class="form-label"
              >Early Bird End Date & Time</label
            >
            <input
              type="datetime-local"
              class="form-control"
              id="earlyBirdEndDate"
              formControlName="earlyBirdEndDate"
            />
            <small class="form-text text-muted"
              >When early bird pricing expires</small
            >
          </div>

          <div class="mb-3">
            <label for="regularPrice" class="form-label"
              >Regular Price ($)</label
            >
            <input
              type="number"
              class="form-control"
              id="regularPrice"
              formControlName="regularPrice"
              min="0"
              max="1000"
              step="0.01"
            />
            <small class="form-text text-muted"
              >Standard registration fee after early bird expires</small
            >
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="registrationOpenDate" class="form-label"
                >Registration Opens</label
              >
              <input
                type="datetime-local"
                class="form-control"
                id="registrationOpenDate"
                formControlName="registrationOpenDate"
              />
              <small class="form-text text-muted"
                >When registration becomes available</small
              >
            </div>

            <div class="col-md-6 mb-3">
              <label for="registrationCloseDate" class="form-label"
                >Registration Closes</label
              >
              <input
                type="datetime-local"
                class="form-control"
                id="registrationCloseDate"
                formControlName="registrationCloseDate"
              />
              <small class="form-text text-muted">When registration ends</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeModal()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="leagueForm.invalid || isLoading()"
          >
            @if (isLoading()) {
            <span class="spinner-border spinner-border-sm me-2"></span>
            } Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show"></div>
}
